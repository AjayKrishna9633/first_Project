<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - GEARGRID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/public/css/text-wrap.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        .progress-step {
            transition: all 0.3s ease;
        }
        .progress-step.active {
            transform: scale(1.1);
        }
        .progress-line {
            transition: all 0.5s ease;
        }
        .progress-line.completed {
            background: linear-gradient(90deg, #06b6d4, #3b82f6);
        }
        
        /* Tooltip styling for formatted numbers */
        [title] {
            cursor: help;
            position: relative;
        }
        
        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }
        
        [title]:hover::before {
            content: '';
            position: absolute;
            bottom: 95%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-black text-white">
    <!-- Header -->
    <%- include('../partials/header') %>

    <!-- Breadcrumb -->
    <div class="bg-gray-900 border-b border-gray-800 mt-20">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center text-sm">
                <a href="/" class="text-gray-300 hover:text-white transition">Home</a>
                <i class="fas fa-chevron-right mx-2 text-xs text-gray-500"></i>
                <a href="/orders" class="text-gray-300 hover:text-white transition">My Orders</a>
                <i class="fas fa-chevron-right mx-2 text-xs text-gray-500"></i>
                <span class="text-white font-medium">Order #<%= order.orderNumber %></span>
            </div>
        </div>
    </div>

    <!-- Page Header -->
    <div class="bg-gray-900 py-8 px-6 border-b border-gray-800">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-white mb-2">Order Details</h1>
                <p class="text-gray-400">Order #<%= order.orderNumber %></p>
            </div>
            <div class="flex gap-3">
                <a href="/orders" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Orders
                </a>
                <% if (['pending', 'confirmed'].includes(order.orderStatus)) { %>
                    <button onclick="cancelOrder('<%= order._id %>')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                        <i class="fas fa-times mr-2"></i>Cancel Order
                    </button>
                <% } %>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Payment Pending Alert -->
        <% if (order.paymentMethod === 'online' && order.paymentStatus === 'pending' && order.orderStatus !== 'cancelled') { %>
            <div class="bg-orange-900 border border-orange-700 rounded-lg p-6 mb-8">
                <div class="flex items-center gap-3">
                    <i class="fas fa-exclamation-triangle text-3xl text-orange-400"></i>
                    <div class="flex-1">
                        <h2 class="text-xl font-semibold text-white">Payment Pending</h2>
                        <p class="text-orange-300">Your order is awaiting payment confirmation. Please complete the payment to process your order.</p>
                    </div>
                    <button onclick="retryPayment('<%= order._id %>', <%= order.totalAmount %>)" 
                            class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition font-semibold">
                        <i class="fas fa-credit-card mr-2"></i>Complete Payment
                    </button>
                </div>
            </div>
        <% } %>
        
        <!-- Order Progress Tracker -->
        <% if (order.orderStatus !== 'cancelled') { %>
            <div class="bg-gray-900 rounded-lg border border-gray-800 p-8 mb-8">
                <h2 class="text-2xl font-semibold text-white mb-8 text-center">Order Progress</h2>
                
                <div class="relative">
                    <!-- Progress Line -->
                    <div class="absolute top-6 left-0 w-full h-1 bg-gray-700 rounded-full">
                        <div class="progress-line h-full rounded-full <%= orderProgress.percentage >= 20 ? 'completed' : 'bg-gray-700' %>" 
                             style="width: <%= orderProgress.percentage %>%"></div>
                    </div>
                    
                    <!-- Progress Steps -->
                    <div class="relative flex justify-between">
                        <!-- Step 1: Order Placed -->
                        <div class="progress-step flex flex-col items-center <%= orderProgress.step >= 1 ? 'active' : '' %>">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3 <%= orderProgress.step >= 1 ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-400' %>">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <span class="text-sm font-medium <%= orderProgress.step >= 1 ? 'text-white' : 'text-gray-400' %>">Order Placed</span>
                            <span class="text-xs text-gray-500 mt-1"><%= new Date(order.createdAt).toLocaleDateString() %></span>
                        </div>
                        
                        <!-- Step 2: Confirmed -->
                        <div class="progress-step flex flex-col items-center <%= orderProgress.step >= 2 ? 'active' : '' %>">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3 <%= orderProgress.step >= 2 ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-400' %>">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <span class="text-sm font-medium <%= orderProgress.step >= 2 ? 'text-white' : 'text-gray-400' %>">Confirmed</span>
                        </div>
                        
                        <!-- Step 3: Processing -->
                        <div class="progress-step flex flex-col items-center <%= orderProgress.step >= 3 ? 'active' : '' %>">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3 <%= orderProgress.step >= 3 ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-400' %>">
                                <i class="fas fa-cog"></i>
                            </div>
                            <span class="text-sm font-medium <%= orderProgress.step >= 3 ? 'text-white' : 'text-gray-400' %>">Processing</span>
                        </div>
                        
                        <!-- Step 4: Shipped -->
                        <div class="progress-step flex flex-col items-center <%= orderProgress.step >= 4 ? 'active' : '' %>">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3 <%= orderProgress.step >= 4 ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-400' %>">
                                <i class="fas fa-truck"></i>
                            </div>
                            <span class="text-sm font-medium <%= orderProgress.step >= 4 ? 'text-white' : 'text-gray-400' %>">Shipped</span>
                        </div>
                        
                        <!-- Step 5: Delivered -->
                        <div class="progress-step flex flex-col items-center <%= orderProgress.step >= 5 ? 'active' : '' %>">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3 <%= orderProgress.step >= 5 ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-400' %>">
                                <i class="fas fa-home"></i>
                            </div>
                            <span class="text-sm font-medium <%= orderProgress.step >= 5 ? 'text-white' : 'text-gray-400' %>">Delivered</span>
                        </div>
                    </div>
                </div>
                
                <!-- Current Status -->
                <div class="text-center mt-8">
                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full 
                        <%= order.orderStatus === 'delivered' ? 'bg-green-900 text-green-300' : 
                            order.orderStatus === 'shipped' ? 'bg-blue-900 text-blue-300' :
                            order.orderStatus === 'processing' ? 'bg-yellow-900 text-yellow-300' :
                            'bg-gray-800 text-gray-300' %>">
                        <i class="fas fa-info-circle"></i>
                        <span class="font-semibold">Current Status: <%= orderProgress.label %></span>
                    </div>
                </div>
            </div>
        <% } else { %>
            <!-- Cancelled Order Status -->
            <div class="bg-red-900 border border-red-700 rounded-lg p-6 mb-8">
                <div class="flex items-center justify-center gap-3">
                    <i class="fas fa-times-circle text-3xl text-red-400"></i>
                    <div>
                        <h2 class="text-xl font-semibold text-white">Order Cancelled</h2>
                        <p class="text-red-300">This order was cancelled on <%= order.cancelledAt ? new Date(order.cancelledAt).toLocaleDateString() : 'N/A' %></p>
                        <% if (order.cancellationReason) { %>
                            <p class="text-sm text-red-400 mt-1">Reason: <%= order.cancellationReason %></p>
                        <% } %>
                    </div>
                </div>
            </div>
        <% } %>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Order Items -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
                    <h2 class="text-xl font-semibold text-white mb-6">Order Items</h2>
                    <div class="space-y-4">
                        <% order.items.forEach(item => { %>
                            <div class="flex items-center gap-4 p-4 border border-gray-800 rounded-lg hover:border-gray-700 transition <%= item.status === 'cancelled' ? 'opacity-60 bg-gray-800' : '' %>">
                                <div class="w-20 h-20 bg-white rounded-lg overflow-hidden flex-shrink-0">
                                    <% if (item.variantId && item.variantId.images && item.variantId.images.length > 0) { %>
                                        <img src="<%= item.variantId.images[0] %>" alt="Product" class="w-full h-full object-cover">
                                    <% } else { %>
                                        <div class="w-full h-full flex items-center justify-center text-gray-400">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    <% } %>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-white mb-1">
                                        <%= item.productId.productName %>
                                        <% if (item.status === 'cancelled') { %>
                                            <span class="ml-2 px-2 py-1 text-xs bg-red-900 text-red-300 rounded-full">
                                                <i class="fas fa-times mr-1"></i>Cancelled
                                            </span>
                                        <% } %>
                                    </h3>
                                    <p class="text-sm text-gray-400 mb-2">
                                        Color: <%= item.variantId?.color || 'N/A' %> | 
                                        Quantity: <%= item.quantity %>
                                    </p>
                                    <div class="flex items-center gap-4">
                                        <span class="text-sm text-gray-400" title="₹<%= getFullNumber(item.price) %> each">₹<%= formatCurrency(item.price).replace('₹', '') %> each</span>
                                        <span class="font-semibold text-white <%= item.status === 'cancelled' ? 'line-through text-gray-500' : '' %>" title="₹<%= getFullNumber(item.totalPrice) %>">
                                            <%= formatCurrency(item.totalPrice) %>
                                        </span>
                                    </div>
                                    <% if (item.status === 'cancelled' && item.cancellationReason) { %>
                                        <p class="text-xs text-red-400 mt-1">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Cancelled: <%= item.cancellationReason %>
                                        </p>
                                    <% } %>
                                </div>
                                <div class="text-right flex flex-col gap-2">
                                    <a href="/product/<%= item.productId._id %>" class="text-cyan-400 hover:text-cyan-300 text-sm">
                                        <i class="fas fa-external-link-alt mr-1"></i>View Product
                                    </a>
                                    
                                    <!-- Cancel Item Button -->
                                    <% if (item.status === 'active' && ['pending', 'confirmed', 'processing'].includes(order.orderStatus)) { %>
                                        <% if (!order.couponCode) { %>
                                            <button onclick="cancelOrderItem('<%= order._id %>', '<%= item._id %>')" 
                                                    class="text-red-400 hover:text-red-300 text-sm">
                                                <i class="fas fa-times mr-1"></i>Cancel Item
                                            </button>
                                        <% } else { %>
                                            <span class="text-gray-500 text-xs italic" title="Individual items cannot be cancelled for orders with coupons">
                                                <i class="fas fa-lock mr-1"></i>Cancel Locked
                                            </span>
                                        <% } %>
                                    <% } %>
                                    
                                    <!-- Return Item Button -->
                                    <% if (order.orderStatus === 'delivered' && item.status === 'active') { %>
                                        <% if (!order.couponCode) { %>
                                            <% if (item.returnStatus === 'none') { %>
                                                <button onclick="requestItemReturn('<%= order._id %>', '<%= item._id %>')" 
                                                        class="text-orange-400 hover:text-orange-300 text-sm">
                                                    <i class="fas fa-undo mr-1"></i>Return Item
                                                </button>
                                            <% } else if (item.returnStatus === 'requested') { %>
                                                <span class="text-yellow-400 text-xs">
                                                    <i class="fas fa-clock mr-1"></i>Return Requested
                                                </span>
                                            <% } else if (item.returnStatus === 'approved') { %>
                                                <span class="text-blue-400 text-xs">
                                                    <i class="fas fa-check mr-1"></i>Return Approved
                                                </span>
                                            <% } else if (item.returnStatus === 'completed') { %>
                                                <span class="text-green-400 text-xs">
                                                    <i class="fas fa-check-circle mr-1"></i>Returned
                                                </span>
                                            <% } else if (item.returnStatus === 'rejected') { %>
                                                <span class="text-red-400 text-xs">
                                                    <i class="fas fa-times mr-1"></i>Return Rejected
                                                </span>
                                            <% } %>
                                        <% } else { %>
                                            <span class="text-gray-500 text-xs italic" title="Individual items cannot be returned for orders with coupons">
                                                <i class="fas fa-lock mr-1"></i>Return Locked
                                            </span>
                                        <% } %>
                                    <% } %>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">Shipping Address</h2>
                    <div class="bg-gray-800 rounded-lg p-4">
                        <div class="text-gray-300">
                            <p class="font-semibold text-white mb-2"><%= order.shippingAddress.fullName %></p>
                            <p><%= order.shippingAddress.streetAddress %></p>
                            <p><%= order.shippingAddress.city %>, <%= order.shippingAddress.state %> <%= order.shippingAddress.pinCode %></p>
                            <p><%= order.shippingAddress.country %></p>
                            <p class="mt-2 flex items-center gap-2">
                                <i class="fas fa-phone text-cyan-400"></i>
                                <%= order.shippingAddress.phone %>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="space-y-6">
                <!-- Order Info -->
                <div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">Order Information</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Order Number:</span>
                            <span class="font-medium text-white">#<%= order.orderNumber %></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Order Date:</span>
                            <span class="font-medium text-white"><%= new Date(order.createdAt).toLocaleDateString('en-IN') %></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Payment Method:</span>
                            <span class="font-medium text-white uppercase"><%= order.paymentMethod %></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Payment Status:</span>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full 
                                <%= order.paymentStatus === 'paid' ? 'bg-green-900 text-green-300' : 
                                    order.paymentStatus === 'failed' ? 'bg-red-900 text-red-300' :
                                    'bg-yellow-900 text-yellow-300' %>">
                                <%= order.paymentStatus.charAt(0).toUpperCase() + order.paymentStatus.slice(1) %>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Price Breakdown -->
                <div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">Price Details</h2>
                    <div class="space-y-3">
                        <% 
                            const activeItems = order.items.filter(item => item.status === 'active');
                            const cancelledItems = order.items.filter(item => item.status === 'cancelled');
                            const allItemsCancelled = activeItems.length === 0 && cancelledItems.length > 0;
                        %>
                        
                        <% if (allItemsCancelled) { %>
                            <!-- When all items are cancelled, show different layout -->
                            <div class="flex justify-between text-red-400">
                                <span>All items cancelled (<%= cancelledItems.length %> items):</span>
                                <span title="₹<%= getFullNumber(cancelledItems.reduce((sum, item) => sum + item.totalPrice, 0)) %>"><%= formatCurrency(cancelledItems.reduce((sum, item) => sum + item.totalPrice, 0)) %></span>
                            </div>
                            <div class="flex justify-between text-gray-500 text-sm">
                                <span>Order Total (before cancellation):</span>
                                <span class="line-through" title="₹<%= getFullNumber(cancelledItems.reduce((sum, item) => sum + item.totalPrice, 0) + (order.shippingCost || 0) + (order.tax || 0)) %>"><%= formatCurrency(cancelledItems.reduce((sum, item) => sum + item.totalPrice, 0) + (order.shippingCost || 0) + (order.tax || 0)) %></span>
                            </div>
                            <div class="border-t border-gray-700 pt-3">
                                <div class="flex justify-between text-xl font-bold text-red-400">
                                    <span>Final Total:</span>
                                    <span>₹0 (Order Cancelled)</span>
                                </div>
                            </div>
                        <% } else { %>
                            <!-- Normal display when some items are active -->
                            <div class="flex justify-between text-gray-300">
                                <span>Subtotal (<%= activeItems.length %> active items):</span>
                                <span title="₹<%= getFullNumber(order.subtotal) %>"><%= formatCurrency(order.subtotal) %></span>
                            </div>
                            <% if (cancelledItems.length > 0) { %>
                                <div class="flex justify-between text-red-400 text-sm">
                                    <span>Cancelled items (<%= cancelledItems.length %>):</span>
                                    <span title="-₹<%= getFullNumber(cancelledItems.reduce((sum, item) => sum + item.totalPrice, 0)) %>">-<%= formatCurrency(cancelledItems.reduce((sum, item) => sum + item.totalPrice, 0)) %></span>
                                </div>
                            <% } %>
                            <div class="flex justify-between text-gray-300">
                                <span>Shipping:</span>
                                <span class="<%= order.shippingCost === 0 ? 'text-green-400' : '' %>" title="₹<%= getFullNumber(order.shippingCost) %>">
                                    <%= order.shippingCost === 0 ? 'FREE' : formatCurrency(order.shippingCost) %>
                                </span>
                            </div>
                            <div class="flex justify-between text-gray-300">
                                <span>Tax:</span>
                                <span title="₹<%= getFullNumber(order.tax) %>"><%= formatCurrency(order.tax) %></span>
                            </div>
                            <div class="border-t border-gray-700 pt-3">
                                <div class="flex justify-between text-xl font-bold text-white">
                                    <span>Total:</span>
                                    <span class="text-cyan-400" title="₹<%= getFullNumber(order.totalAmount) %>"><%= formatCurrency(order.totalAmount) %></span>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>

               <!-- Order Actions -->
<div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
    <h2 class="text-xl font-semibold text-white mb-4">Actions</h2>
    <div class="space-y-3">
        <!-- Retry Payment for Failed Online Orders -->
        <% if (order.paymentMethod === 'online' && order.paymentStatus === 'pending' && !['delivered', 'cancelled', 'returned'].includes(order.orderStatus)) { %>
            <button onclick="retryPayment('<%= order._id %>', <%= order.totalAmount %>)" 
                    class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition">
                <i class="fas fa-redo mr-2"></i>Retry Payment
            </button>
        <% } %>
        
        <!-- Pay Now for COD Orders -->
        <% if (order.paymentMethod === 'cod' && order.paymentStatus === 'pending' && !['delivered', 'cancelled', 'returned'].includes(order.orderStatus)) { %>
            <button onclick="payNowCOD('<%= order._id %>', <%= order.totalAmount %>)" 
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition">
                <i class="fas fa-credit-card mr-2"></i>Pay Now Online
            </button>
        <% } %>
        
        <% if (order.orderStatus === 'delivered') { %>
            <button onclick="reorderItems('<%= order._id %>')" 
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition">
                <i class="fas fa-redo mr-2"></i>Reorder Items
            </button>
        <% } %>
        
        <% if (['pending', 'confirmed'].includes(order.orderStatus)) { %>
            <button onclick="cancelOrder('<%= order._id %>')" 
                    class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition">
                <i class="fas fa-times mr-2"></i>Cancel Order
            </button>
        <% } %>
        
        <!-- Return functionality -->
        <% if (order.orderStatus === 'delivered' && order.returnStatus === 'none') { %>
            <button onclick="requestReturn('<%= order._id %>')" 
                class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition">
                <i class="fas fa-undo mr-2"></i>Request Return
            </button>
        <% } else if (order.returnStatus === 'requested') { %>
            <div class="w-full bg-yellow-100 text-yellow-800 py-2 px-4 rounded-lg text-center">
                <i class="fas fa-clock mr-2"></i>Return Requested - Pending Review
            </div>
        <% } else if (order.returnStatus === 'approved') { %>
            <div class="w-full bg-blue-100 text-blue-800 py-2 px-4 rounded-lg text-center">
                <i class="fas fa-check mr-2"></i>Return Approved - Processing
            </div>
        <% } else if (order.returnStatus === 'completed') { %>
            <div class="w-full bg-green-100 text-green-800 py-2 px-4 rounded-lg text-center">
                <i class="fas fa-check-circle mr-2"></i>Return Completed - Refund Processed
            </div>
        <% } else if (order.returnStatus === 'rejected') { %>
            <div class="w-full bg-red-100 text-red-800 py-2 px-4 rounded-lg text-center">
                <i class="fas fa-times mr-2"></i>Return Request Rejected
            </div>
        <% } %>
        
        <% if (order.orderStatus === 'delivered') { %>
            <button onclick="downloadInvoice('<%= order._id %>')" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-download mr-2"></i>Download Invoice
            </button>
        <% } %>
        
        <button onclick="contactSupport()" 
                class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition">
            <i class="fas fa-headset mr-2"></i>Contact Support
        </button>
    </div>
</div>
                <!-- Order Notes -->
                <% if (order.orderNotes) { %>
                    <div class="bg-gray-900 rounded-lg border border-gray-800 p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">Order Notes</h2>
                        <p class="text-gray-300 text-sm"><%= order.orderNotes %></p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <%- include('../partials/footer') %>

    <script>
       async function cancelOrder(orderId) {
    const cancellationReasons = [
    { value: 'CHANGED_MIND', label: 'Changed my mind' },
    { value: 'ORDERED_MISTAKE', label: 'Ordered by mistake' },
    { value: 'FOUND_BETTER_PRICE', label: 'Found better price elsewhere' },
    { value: 'DELAYED_DELIVERY', label: 'Delivery taking too long' },
    { value: 'OTHER', label: 'Other' }
];

    const optionsHtml = cancellationReasons.map(reason => 
        `<option value="${reason.value}">${reason.label}</option>`
    ).join('');

    const { value: formValues } = await Swal.fire({
        title: 'Cancel Order',
        html: `
            <div class="text-left space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Why are you cancelling this order? *
                    </label>
                    <select id="cancellationReason" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition">
                        <option value="">Please select a reason</option>
                        ${optionsHtml}
                    </select>
                </div>
                <div id="otherReasonDiv" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Please provide details *
                    </label>
                    <textarea 
                        id="otherReason" 
                        rows="4" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition resize-none" 
                        placeholder="Please tell us more about your reason for cancellation..."
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">This helps us improve our service</p>
                </div>
            </div>
        `,
        width: '500px',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '<i class="fas fa-times mr-2"></i>Cancel Order',
        cancelButtonText: '<i class="fas fa-arrow-left mr-2"></i>Keep Order',
        focusConfirm: false,
        customClass: {
            popup: 'rounded-xl',
            title: 'text-lg font-semibold',
            htmlContainer: 'text-sm'
        },
        didOpen: () => {
            const reasonSelect = document.getElementById('cancellationReason');
            const otherDiv = document.getElementById('otherReasonDiv');
            
            reasonSelect.addEventListener('change', function() {
                if (this.value === 'other') {
                    otherDiv.classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('otherReason').focus();
                    }, 100);
                } else {
                    otherDiv.classList.add('hidden');
                }
            });
        },
        preConfirm: () => {
            const selectedReason = document.getElementById('cancellationReason').value;
            const otherReason = document.getElementById('otherReason').value;
            
            if (!selectedReason) {
                Swal.showValidationMessage('Please select a cancellation reason');
                return false;
            }
            
            if (selectedReason === 'other' && !otherReason.trim()) {
                Swal.showValidationMessage('Please provide details for your cancellation');
                return false;
            }
            
            // Find the label for the selected reason
            const reasonLabel = cancellationReasons.find(r => r.value === selectedReason)?.label;
            
            return {
                reason: selectedReason === 'other' ? otherReason.trim() : reasonLabel,
                category: selectedReason,
                reasonCode: selectedReason
            };
        }
    });

    if (formValues) {
        try {
          
            Swal.fire({
                title: 'Cancelling Order...',
                text: 'Please wait while we process your cancellation',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch(`/orders/${orderId}/cancel`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    reason: formValues.reason,
                    category: formValues.category,
                    reasonCode: formValues.reasonCode
                })
            });

            const result = await response.json();
            
            if (result.success) {
                await Swal.fire({
                    title: 'Order Cancelled!',
                    text: 'Your order has been cancelled successfully. Any payment will be refunded within 3-5 business days.',
                    icon: 'success',
                    confirmButtonColor: '#10b981',
                    confirmButtonText: 'Got it'
                });
                location.reload();
            } else {
                Swal.fire({
                    title: 'Cancellation Failed',
                    text: result.message || 'Unable to cancel the order at this time.',
                    icon: 'error',
                    confirmButtonColor: '#dc2626'
                });
            }
        } catch (error) {
            console.error('Cancel order error:', error);
            Swal.fire({
                title: 'Connection Error',
                text: 'Failed to cancel order. Please check your connection and try again.',
                icon: 'error',
                confirmButtonColor: '#dc2626'
            });
        }
    }
}


       async function downloadInvoice(orderId) {
    try {
        // Show loading
        Swal.fire({
            title: 'Generating Invoice...',
            text: 'Please wait while we prepare your invoice',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Create a temporary link to download the PDF
        const link = document.createElement('a');
        link.href = `/orders/${orderId}/invoice`;
        link.download = `invoice-${orderId}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Close loading and show success
        setTimeout(() => {
            Swal.fire({
                icon: 'success',
                title: 'Invoice Downloaded!',
                text: 'Your invoice has been downloaded successfully',
                timer: 2000,
                showConfirmButton: false
            });
        }, 1000);

    } catch (error) {
        console.error('Error downloading invoice:', error);
        Swal.fire({
            title: 'Error!',
            text: 'Failed to download invoice. Please try again.',
            icon: 'error',
            confirmButtonColor: '#06b6d4'
        });
    }
}


        async function requestReturn(orderId) {
            const { value: formValues } = await Swal.fire({
                title: 'Request Return',
                html: `
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Return:</label>
                        <select id="returnReason" class="w-full p-2 border border-gray-300 rounded-lg mb-4">
                            <option value="">Select a reason</option>
                            <option value="DEFECTIVE">Defective product</option>
                            <option value="DAMAGED_SHIPPING">Damaged during shipping</option>
                            <option value="WRONG_ITEM">Wrong item received</option>
                            <option value="NO_LONGER_NEEDED">No longer needed</option>
                            <option value="BETTER_PRICE">Found better price elsewhere</option>
                            <option value="ORDERED_MISTAKE">Ordered by mistake</option>
                            <option value="LATE_ARRIVAL">Late arrival</option>
                            <option value="OTHER">Other</option>
                        </select>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes:</label>
                        <textarea id="returnNotes" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" 
                            placeholder="Please provide additional details..."></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Submit Return Request',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ea580c',
                preConfirm: () => {
                    const reason = document.getElementById('returnReason').value;
                    const notes = document.getElementById('returnNotes').value;
                    
                    if (!reason) {
                        Swal.showValidationMessage('Please select a reason for return');
                        return false;
                    }
                    
                    return { reason, notes };
                }
            });

            if (formValues) {
                try {
                    const response = await fetch('/orders/return/request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderId: orderId,
                            returnReason: formValues.reason,
                            returnNotes: formValues.notes
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        Swal.fire('Success!', result.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Failed to submit return request', 'error');
                }
            }
        }

        // Request Individual Item Return
        async function requestItemReturn(orderId, itemId) {
            const { value: formValues } = await Swal.fire({
                title: 'Request Item Return',
                html: `
                    <div class="text-left">
                        <p class="text-sm text-gray-600 mb-4">You are requesting a return for this specific item only.</p>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Return:</label>
                        <select id="itemReturnReason" class="w-full p-2 border border-gray-300 rounded-lg mb-4">
                            <option value="">Select a reason</option>
                            <option value="DEFECTIVE">Defective product</option>
                            <option value="DAMAGED_SHIPPING">Damaged during shipping</option>
                            <option value="WRONG_ITEM">Wrong item received</option>
                            <option value="NO_LONGER_NEEDED">No longer needed</option>
                            <option value="BETTER_PRICE">Found better price elsewhere</option>
                            <option value="ORDERED_MISTAKE">Ordered by mistake</option>
                            <option value="LATE_ARRIVAL">Late arrival</option>
                            <option value="OTHER">Other</option>
                        </select>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes:</label>
                        <textarea id="itemReturnNotes" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" 
                            placeholder="Please provide additional details..."></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Submit Return Request',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ea580c',
                preConfirm: () => {
                    const reason = document.getElementById('itemReturnReason').value;
                    const notes = document.getElementById('itemReturnNotes').value;
                    
                    if (!reason) {
                        Swal.showValidationMessage('Please select a reason for return');
                        return false;
                    }
                    
                    return { reason, notes };
                }
            });

            if (formValues) {
                try {
                    const response = await fetch('/orders/return/item-request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderId: orderId,
                            itemId: itemId,
                            returnReason: formValues.reason,
                            returnNotes: formValues.notes
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        Swal.fire('Success!', result.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', result.message, 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Failed to submit item return request', 'error');
                }
            }
        }

        async function cancelOrderItem(orderId, itemId) {
            const cancellationReasons = [
                { value: 'CHANGED_MIND', label: 'Changed my mind about this item' },
                { value: 'ORDERED_MISTAKE', label: 'Ordered by mistake' },
                { value: 'FOUND_BETTER_PRICE', label: 'Found better price elsewhere' },
                { value: 'NO_LONGER_NEEDED', label: 'No longer needed' },
                { value: 'OTHER', label: 'Other' }
            ];

            const optionsHtml = cancellationReasons.map(reason => 
                `<option value="${reason.value}">${reason.label}</option>`
            ).join('');

            const { value: formValues } = await Swal.fire({
                title: 'Cancel Item',
                html: `
                    <div class="text-left space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Why are you cancelling this item? *
                            </label>
                            <select id="itemCancellationReason" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition">
                                <option value="">Please select a reason</option>
                                ${optionsHtml}
                            </select>
                        </div>
                        <div id="itemOtherReasonDiv" class="hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Please provide details *
                            </label>
                            <textarea 
                                id="itemOtherReason" 
                                rows="3" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition resize-none" 
                                placeholder="Please tell us more about your reason for cancellation..."
                            ></textarea>
                        </div>
                    </div>
                `,
                width: '500px',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '<i class="fas fa-times mr-2"></i>Cancel Item',
                cancelButtonText: '<i class="fas fa-arrow-left mr-2"></i>Keep Item',
                focusConfirm: false,
                customClass: {
                    popup: 'rounded-xl',
                    title: 'text-lg font-semibold',
                    htmlContainer: 'text-sm'
                },
                didOpen: () => {
                    const reasonSelect = document.getElementById('itemCancellationReason');
                    const otherDiv = document.getElementById('itemOtherReasonDiv');
                    
                    reasonSelect.addEventListener('change', function() {
                        if (this.value === 'OTHER') {
                            otherDiv.classList.remove('hidden');
                            setTimeout(() => {
                                document.getElementById('itemOtherReason').focus();
                            }, 100);
                        } else {
                            otherDiv.classList.add('hidden');
                        }
                    });
                },
                preConfirm: () => {
                    const selectedReason = document.getElementById('itemCancellationReason').value;
                    const otherReason = document.getElementById('itemOtherReason').value;
                    
                    if (!selectedReason) {
                        Swal.showValidationMessage('Please select a cancellation reason');
                        return false;
                    }
                    
                    if (selectedReason === 'OTHER' && !otherReason.trim()) {
                        Swal.showValidationMessage('Please provide details for your cancellation');
                        return false;
                    }
                    
                    // Find the label for the selected reason
                    const reasonLabel = cancellationReasons.find(r => r.value === selectedReason)?.label;
                    
                    return {
                        reason: selectedReason === 'OTHER' ? otherReason.trim() : reasonLabel
                    };
                }
            });

            if (formValues) {
                try {
                    // Show loading
                    Swal.fire({
                        title: 'Cancelling Item...',
                        text: 'Please wait while we process your cancellation',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    const response = await fetch(`/orders/${orderId}/items/${itemId}/cancel`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            reason: formValues.reason
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        let message = 'Item has been cancelled successfully.';
                        
                        if (result.orderStatus === 'cancelled') {
                            message += ' Since all items were cancelled, the entire order has been cancelled.';
                        } else {
                            message += ` Order total updated to ₹${result.newTotal.toLocaleString()}.`;
                        }

                        await Swal.fire({
                            title: 'Item Cancelled!',
                            text: message,
                            icon: 'success',
                            confirmButtonColor: '#10b981',
                            confirmButtonText: 'Got it'
                        });
                        location.reload();
                    } else {
                        Swal.fire({
                            title: 'Cancellation Failed',
                            text: result.message || 'Unable to cancel the item at this time.',
                            icon: 'error',
                            confirmButtonColor: '#dc2626'
                        });
                    }
                } catch (error) {
                    console.error('Cancel item error:', error);
                    Swal.fire({
                        title: 'Connection Error',
                        text: 'Failed to cancel item. Please check your connection and try again.',
                        icon: 'error',
                        confirmButtonColor: '#dc2626'
                    });
                }
            }
        }

        function contactSupport() {
            Swal.fire({
                title: 'Contact Support',
                html: `
                    <div class="text-left">
                        <p class="mb-3">Need help with your order? Contact our support team:</p>
                        <div class="space-y-2">
                            <p><i class="fas fa-phone text-cyan-400 mr-2"></i> +91 1234567890</p>
                            <p><i class="fas fa-envelope text-cyan-400 mr-2"></i> support@geargrid.com</p>
                            <p><i class="fas fa-clock text-cyan-400 mr-2"></i> Mon-Sat: 9 AM - 6 PM</p>
                        </div>
                    </div>
                `,
                confirmButtonColor: '#06b6d4',
                confirmButtonText: 'Got it'
            });
        }

        // Pay Now for COD Orders
        async function payNowCOD(orderId, amount) {
            try {
                const result = await Swal.fire({
                    title: 'Convert to Online Payment',
                    html: `
                        <div class="text-left space-y-4">
                            <p class="text-gray-600">Convert your Cash on Delivery order to online payment.</p>
                            <div class="bg-cyan-50 border border-cyan-200 rounded-lg p-4">
                                <p class="text-sm text-gray-700">
                                    <i class="fas fa-info-circle text-cyan-500 mr-2"></i>
                                    Amount to pay: <strong class="text-cyan-600">₹${amount.toLocaleString()}</strong>
                                </p>
                            </div>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-shield-alt text-green-500 mr-1"></i>
                                Secure payment via Razorpay
                            </p>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: '<i class="fas fa-credit-card mr-2"></i>Proceed to Pay',
                    cancelButtonText: 'Cancel'
                });

                if (!result.isConfirmed) return;

                // Show loading
                Swal.fire({
                    title: 'Processing...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Create Razorpay order
                const response = await fetch(`/orders/${orderId}/pay-cod`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    Swal.close();
                    
                    // Open Razorpay
                    const options = {
                        "key": data.razorpayOrder.key_id,
                        "amount": data.razorpayOrder.amount,
                        "currency": data.razorpayOrder.currency,
                        "name": "GearGrid",
                        "description": `Payment for Order #${data.orderNumber}`,
                        "order_id": data.razorpayOrder.id,
                        "handler": async function (response) {
                            await verifyPaymentCOD(orderId, response);
                        },
                        "theme": {
                            "color": "#06b6d4"
                        },
                        "modal": {
                            "ondismiss": function() {
                                Swal.fire('Cancelled', 'Payment was cancelled', 'info');
                            }
                        }
                    };
                    
                    const rzp = new Razorpay(options);
                    rzp.open();
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            } catch (error) {
                console.error('Pay COD error:', error);
                Swal.fire('Error', 'Failed to process payment', 'error');
            }
        }

        // Verify Payment for COD
        async function verifyPaymentCOD(orderId, response) {
            try {
                Swal.fire({
                    title: 'Verifying Payment...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const verifyResponse = await fetch(`/orders/${orderId}/verify-cod-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature
                    })
                });

                const result = await verifyResponse.json();

                if (result.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Payment Successful!',
                        text: 'Your order has been converted to prepaid.',
                        confirmButtonColor: '#10b981'
                    });
                    location.reload();
                } else {
                    Swal.fire('Failed', result.message, 'error');
                }
            } catch (error) {
                console.error('Verification error:', error);
                Swal.fire('Error', 'Payment verification failed', 'error');
            }
        }

        // Retry Payment for Failed Online Orders
        async function retryPayment(orderId, amount) {
            try {
                const result = await Swal.fire({
                    title: 'Retry Payment',
                    html: `
                        <div class="text-left space-y-4">
                            <p class="text-gray-600">Complete your pending payment to confirm your order.</p>
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <p class="text-sm text-gray-700">
                                    <i class="fas fa-info-circle text-orange-500 mr-2"></i>
                                    Amount to pay: <strong class="text-orange-600">₹${amount.toLocaleString()}</strong>
                                </p>
                            </div>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-shield-alt text-green-500 mr-1"></i>
                                Secure payment via Razorpay
                            </p>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonColor: '#ea580c',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: '<i class="fas fa-credit-card mr-2"></i>Proceed to Pay',
                    cancelButtonText: 'Cancel'
                });

                if (!result.isConfirmed) return;

                Swal.fire({
                    title: 'Processing...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch(`/orders/${orderId}/retry-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    Swal.close();
                    
                    const options = {
                        "key": data.razorpayOrder.key_id,
                        "amount": data.razorpayOrder.amount,
                        "currency": data.razorpayOrder.currency,
                        "name": "GearGrid",
                        "description": `Payment for Order #${data.orderNumber}`,
                        "order_id": data.razorpayOrder.id,
                        "handler": async function (response) {
                            await verifyRetryPayment(orderId, response);
                        },
                        "theme": {
                            "color": "#ea580c"
                        },
                        "modal": {
                            "ondismiss": function() {
                                Swal.fire('Cancelled', 'Payment was cancelled', 'info');
                            }
                        }
                    };
                    
                    const rzp = new Razorpay(options);
                    rzp.open();
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            } catch (error) {
                console.error('Retry payment error:', error);
                Swal.fire('Error', 'Failed to process payment', 'error');
            }
        }

        // Verify Retry Payment
        async function verifyRetryPayment(orderId, response) {
            try {
                Swal.fire({
                    title: 'Verifying Payment...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const verifyResponse = await fetch(`/orders/${orderId}/verify-retry-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature
                    })
                });

                const result = await verifyResponse.json();

                if (result.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Payment Successful!',
                        text: 'Your order payment has been completed successfully.',
                        confirmButtonColor: '#10b981'
                    });
                    location.reload();
                } else {
                    Swal.fire('Failed', result.message, 'error');
                }
            } catch (error) {
                console.error('Verification error:', error);
                Swal.fire('Error', 'Payment verification failed', 'error');
            }
        }
    </script>
</body>
</html>
