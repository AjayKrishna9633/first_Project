<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GEARGRID - Email Confirmation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/public/css/text-wrap.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
      }
      .otp-input {
        width: 50px;
        height: 50px;
        font-size: 24px;
        text-align: center;
      }
      .otp-input::-webkit-outer-spin-button,
      .otp-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
    </style>
  </head>
 
    
  <body
    class="bg-neutral-900 min-h-screen flex items-center justify-center p-4">
 
    <div
      class="bg-white rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl"
    >
      <!-- Email Icon -->
      <div class="mb-6 flex justify-center">
        <svg
          class="w-24 h-24"
          viewBox="0 0 100 100"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect
            x="10"
            y="25"
            width="80"
            height="50"
            stroke="black"
            stroke-width="2"
            fill="white"
          />
          <path
            d="M10 25 L50 55 L90 25"
            stroke="black"
            stroke-width="2"
            fill="none"
          />
        </svg>
      </div>

      <h2 class="text-2xl font-semibold text-black mb-2">Email Confirmation</h2>

      <!-- OTP Input Boxes -->
      <div class="flex justify-center gap-3 mb-6">
        <input
          type="text"
          maxlength="1"
          class="otp-input bg-black text-white rounded border-0 focus:outline-none focus:ring-2 focus:ring-gray-500"
          oninput="moveToNext(this, 1)"
          id="otp-0"
        />
        <input
          type="text"
          maxlength="1"
          class="otp-input bg-black text-white rounded border-0 focus:outline-none focus:ring-2 focus:ring-gray-500"
          oninput="moveToNext(this, 2)"
          id="otp-1"
        />
        <input
          type="text"
          maxlength="1"
          class="otp-input bg-black text-white rounded border-0 focus:outline-none focus:ring-2 focus:ring-gray-500"
          oninput="moveToNext(this, 3)"
          id="otp-2"
        />
        <input
          type="text"
          maxlength="1"
          class="otp-input bg-black text-white rounded border-0 focus:outline-none focus:ring-2 focus:ring-gray-500"
          oninput="moveToNext(this, 4)"
          id="otp-3"
        />
        <input
          type="text"
          maxlength="1"
          class="otp-input bg-black text-white rounded border-0 focus:outline-none focus:ring-2 focus:ring-gray-500"
          oninput="moveToNext(this, 5)"
          id="otp-4"
        />
        <input
          type="text"
          maxlength="1"
          class="otp-input bg-black text-white rounded border-0 focus:outline-none focus:ring-2 focus:ring-gray-500"
          oninput="moveToNext(this, 6)"
          id="otp-5"
        />
      </div>
      <!-- Timer and Resend -->
      <div class="mb-6">
        <p class="text-sm text-gray-600 mb-1">
          Verify in: <span id="timer" class="font-semibold">06</span>
        </p>
        <p class="text-sm text-gray-600">
          Didn't receive code?
          <a
            href="#"
            onclick="resendOTP(); return false;"
            class="text-blue-600 hover:underline"
            >Resend OTP</a
          >
        </p>
      </div>

      <!-- Confirm Button -->
      <button
        onclick="confirmOTP()"
        class="w-full bg-black hover:bg-gray-800 text-white font-medium py-3 rounded-lg transition"
      >
        CONFIRM
      </button>
    </div>

    <script>
      // Timer functionality
      let timeLeft = 60;
      let isExpired = false;
      const timerElement = document.getElementById("timer");

      const countdown = setInterval(() => {
        timeLeft--;
        timerElement.textContent = timeLeft.toString().padStart(2, "0");

        if (timeLeft <= 0) {
          clearInterval(countdown);
          timerElement.textContent = "00";
          isExpired = true;
          handleOTPExpiry();
        }
      }, 1000);

      // Handle OTP expiry
      function handleOTPExpiry() {
        // Disable all OTP inputs
        document.querySelectorAll(".otp-input").forEach(input => {
          input.disabled = true;
          input.classList.add('opacity-50', 'cursor-not-allowed');
        });

        // Show expiry message
        Swal.fire({
          icon: 'warning',
          title: 'OTP Expired',
          text: 'Your OTP has expired. Please click "Resend OTP" to get a new code.',
          confirmButtonColor: '#000',
          confirmButtonText: 'OK'
        });
      }

      // OTP input navigation
      function moveToNext(current, nextIndex) {
        if (current.value.length === 1 && nextIndex < 6) {
          document.getElementById(`otp-${nextIndex}`).focus();
        }
      }

      // Handle backspace
      document.querySelectorAll(".otp-input").forEach((input, index) => {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && input.value === "" && index > 0) {
            document.getElementById(`otp-${index - 1}`).focus();
          }
        });
      });

      // Confirm OTP
      async function confirmOTP() {
        // Check if OTP is expired
        if (isExpired) {
          Swal.fire({
            icon: 'error',
            title: 'OTP Expired',
            text: 'Your OTP has expired. Please click "Resend OTP" to get a new code.',
            confirmButtonColor: '#000'
          });
          return;
        }

        const otp = Array.from(document.querySelectorAll(".otp-input"))
          .map((input) => input.value)
          .join("");

        if (otp.length !== 6) {
          Swal.fire({
            icon: 'warning',
            title: 'Incomplete OTP',
            text: 'Please enter the complete 6-digit OTP',
            confirmButtonColor: '#000'
          });
          return;
        }

        try {
          const response = await fetch('/verify-otp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ otp })
          });

          const data = await response.json();

          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: 'Email verified successfully!',
              confirmButtonColor: '#000'
            }).then(() => {
              window.location.href = data.redirectUrl || '/login';
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Invalid OTP',
              text: data.message || 'Invalid OTP. Please try again.',
              confirmButtonColor: '#000'
            });
            document.querySelectorAll(".otp-input").forEach(input => input.value = "");
            document.getElementById("otp-0").focus();
          }
        } catch (error) {
          console.error("Error:", error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred. Please try again.',
            confirmButtonColor: '#000'
          });
        }
      }

      // Resend OTP
      async function resendOTP() {
        try {
          const response = await fetch('/resend-otp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: '<%= email %>' })
          });

          const data = await response.json();

          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'OTP Resent!',
              text: 'OTP resent successfully! Check your email.',
              confirmButtonColor: '#000'
            });
            
            // Reset timer and expired state
            timeLeft = 60;
            isExpired = false;
            timerElement.textContent = "60";
            
            // Re-enable and clear OTP inputs
            document.querySelectorAll(".otp-input").forEach(input => {
              input.value = "";
              input.disabled = false;
              input.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            
            document.getElementById("otp-0").focus();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Failed',
              text: data.message || 'Failed to resend OTP. Please try again.',
              confirmButtonColor: '#000'
            });
          }
        } catch (error) {
          console.error("Error:", error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred. Please try again.',
            confirmButtonColor: '#000'
          });
        }
      }

      // Focus first input on load
      document.getElementById("otp-0").focus();

    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </body>
</html>
