<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.productName %> - GEARGRID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>.product-card.out-of-stock {
    opacity: 0.5;
    position: relative;
}
/* Add this to your existing style section */
.swal-wide {
    width: 500px !important;
}

.swal-confirm-btn {
    background: linear-gradient(135deg, #06b6d4, #3b82f6) !important;
    color: white !important;
    border: none !important;
    padding: 12px 24px !important;
    border-radius: 8px !important;
    font-weight: 600 !important;
    margin: 0 8px !important;
    transition: all 0.3s ease !important;
}

.swal-confirm-btn:hover {
    background: linear-gradient(135deg, #0891b2, #2563eb) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3) !important;
}

.swal-cancel-btn {
    background: #6b7280 !important;
    color: white !important;
    border: none !important;
    padding: 12px 24px !important;
    border-radius: 8px !important;
    font-weight: 600 !important;
    margin: 0 8px !important;
    transition: all 0.3s ease !important;
}

.swal-cancel-btn:hover {
    background: #4b5563 !important;
    transform: translateY(-2px) !important;
}

.product-card.out-of-stock::after {
    content: 'OUT OF STOCK';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 12px;
    z-index: 10;
}

.product-card.out-of-stock .add-to-cart-btn {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

/* Enhanced Magnifier Lens Styles */
#magnifierLens {
    border: 4px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(1px);
    transition: opacity 0.2s ease;
}

#imageContainer {
    position: relative;
    user-select: none;
}

#mainImage {
    transition: transform 0.1s ease;
}

#imageContainer:hover #mainImage {
    cursor: crosshair;
}
</style>
</head>
<body class="bg-black text-white">
    <!-- Header -->
    <%- include('../partials/header') %>

    <!-- Breadcrumb -->
    <div class="bg-gray-800 border-b border-gray-700 mt-20"></div>
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center text-sm">
                <a href="/" class="text-gray-300 hover:text-white transition">Home</a>
                <i class="fas fa-chevron-right mx-2 text-xs text-gray-500"></i>
                <a href="/shop" class="text-gray-300 hover:text-white transition">Shop</a>
                <% if (product.category && product.category._id) { %>
                    <i class="fas fa-chevron-right mx-2 text-xs text-gray-500"></i>
                    <a href="/shop?category=<%= product.category._id %>" class="text-gray-300 hover:text-white transition"><%= product.category.name %></a>
                <% } %>
                <i class="fas fa-chevron-right mx-2 text-xs text-gray-500"></i>
                <span class="text-white font-medium"><%= product.productName %></span>
            </div>
        </div>
    </div>

    <!-- Product Detail -->
    <div class="max-w-7xl mx-auto px-6 py-8 md:py-12">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            <!-- Left: Product Images -->
            <div>
                <!-- Main Image with Magnifier -->
                <div class="bg-white rounded-lg p-8 mb-4 aspect-square flex items-center justify-center relative overflow-hidden" id="imageContainer">
                    <img id="mainImage" 
                        src="<%= product.variants && product.variants.length > 0 && product.variants[0].images.length > 0 ? product.variants[0].images[0] : '/images/placeholder.png' %>" 
                        alt="<%= product.productName %>"
                        class="max-w-full max-h-full object-contain cursor-crosshair">
                    <!-- Magnifier Lens with Zoom Inside -->
                    <div id="magnifierLens" class="hidden absolute w-40 h-40 border-4 border-white shadow-2xl pointer-events-none rounded-full overflow-hidden bg-white z-20"></div>
                </div>

                <!-- Thumbnail Images -->
                <div id="thumbnailContainer" class="grid grid-cols-4 gap-2">
                    <% if (product.variants && product.variants.length > 0 && product.variants[0].images) { %>
                        <% product.variants[0].images.forEach((image, index) => { %>
                            <div class="thumbnail-item bg-white rounded-lg p-2 cursor-pointer border-2 <%= index === 0 ? 'border-white' : 'border-gray-700' %> hover:border-gray-400 transition"
                                onclick="changeMainImage('<%= image %>', this)">
                                <img src="<%= image %>" alt="Thumbnail <%= index + 1 %>" class="w-full h-full object-contain">
                            </div>
                        <% }); %>
                    <% } %>
                </div>
            </div>

            <!-- Right: Product Info -->
            <div>
                <!-- Product Name -->
                <h1 class="text-3xl md:text-4xl font-bold mb-2"><%= product.productName %></h1>
                
                <!-- Category -->
                <p class="text-gray-400 text-sm uppercase mb-4">
                    <%= product.category ? product.category.name : 'Uncategorized' %>
                </p>

                <!-- Price -->
                <div class="mb-6">
                    <% 
                        let hasDiscount = false;
                        let displayPrice = 0;
                        let originalPrice = 0;
                        let discountPercentage = 0;
                        let appliedOffer = null;

                        if (product.variants && product.variants.length > 0) {
                            const firstVariant = product.variants[0];
                            displayPrice = firstVariant.finalPrice || firstVariant.salePrice;
                            originalPrice = firstVariant.regularPrice;
                            hasDiscount = firstVariant.discountAmount > 0;
                            discountPercentage = firstVariant.discountPercentage || 0;
                            appliedOffer = firstVariant.appliedOffer;
                        }
                    %>

                    <div class="flex items-center gap-3">
                        <p id="productPrice" class="text-3xl md:text-4xl font-bold <%= hasDiscount ? 'text-red-400' : '' %>">
                            ₹<%= displayPrice.toLocaleString() %>
                        </p>
                        <% if (hasDiscount) { %>
                            <p id="productRegularPrice" class="text-gray-400 line-through text-lg">
                                ₹<%= originalPrice.toLocaleString() %>
                            </p>
                            <span id="discountBadge" class="px-3 py-1 rounded-full text-sm font-semibold <%= appliedOffer === 'category' ? 'bg-orange-500/20 text-orange-400' : 'bg-green-500/20 text-green-400' %>">
                                <%= discountPercentage.toFixed(2) %>% OFF
                            </span>
                        <% } else { %>
                            <p id="productRegularPrice" class="text-gray-400 line-through text-lg" style="display: none;"></p>
                            <span id="discountBadge" style="display: none;"></span>
                        <% } %>
                    </div>
                </div>

                <!-- Stock Status -->
                        <div id="stockStatus" class="mb-6">
            <% if (product.variants && product.variants.length > 0) { %>
                <% 
                    const totalStock = product.variants.reduce((sum, variant) => sum + variant.quantity, 0);
                    const hasStock = totalStock > 0;
                %>
                <% if (hasStock) { %>
                    <p class="text-green-500 text-sm">
                        <i class="fas fa-check-circle"></i> In Stock (<span id="stockQuantity"><%= product.variants[0].quantity %></span> available)
                    </p>
                <% } else { %>
                    <p class="text-red-500 text-sm">
                        <i class="fas fa-times-circle"></i> Out of Stock
                    </p>
                <% } %>
            <% } %>
        </div>


                <!-- Color Selector -->
                <% if (product.variants && product.variants.length > 0) { %>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-3">
                            Color: <span id="selectedColorName" class="text-gray-400"><%= product.variants[0].color %></span>
                        </label>
                        <div class="flex flex-wrap gap-3">
                            <% product.variants.forEach((variant, index) => { 
                                const vDisplayPrice = variant.discountedPrice !== undefined ? variant.discountedPrice : variant.salePrice;
                                const vOriginalPrice = variant.originalPrice !== undefined ? variant.originalPrice : variant.salePrice;
                                const vHasDiscount = vDisplayPrice < vOriginalPrice;
                            %>
                                <button 
                                    type="button"
                                    class="color-option px-6 py-3 border-2 rounded-lg transition <%= index === 0 ? 'border-white bg-gray-900' : 'border-gray-700 hover:border-gray-500' %>"
                                    data-variant-id="<%= variant._id %>"
                                    data-color="<%= variant.color %>"
                                    data-price="<%= vDisplayPrice %>"
                                    data-original-price="<%= vOriginalPrice %>"
                                    data-has-discount="<%= vHasDiscount %>"
                                    data-offer-info='<%= variant.appliedOffer ? JSON.stringify(variant.appliedOffer) : "null" %>'
                                    data-quantity="<%= variant.quantity %>"
                                    data-images='<%= JSON.stringify(variant.images) %>'
                                    onclick="selectVariant(this)">
                                    <%= variant.color %>
                                </button>
                            <% }); %>
                        </div>
                    </div>
                <% } %>

                <!-- Quantity Selector -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-3">Quantity (Max 3)</label>
                    <div class="flex items-center gap-3">
                        <button onclick="decreaseQuantity()" 
                            class="w-10 h-10 bg-gray-900 border border-gray-700 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="quantity" value="1" min="1" 
                            class="w-20 text-center bg-gray-900 border border-gray-700 rounded-lg py-2 focus:outline-none focus:border-gray-500">
                        <button onclick="increaseQuantity()" 
                            class="w-10 h-10 bg-gray-900 border border-gray-700 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Maximum 3 units per product</p>
                </div>

                <!-- Action Buttons -->
                <div class="mb-8">
                    <div class="flex gap-3 mb-3">
                        <button id="addToCartBtn" onclick="addToCart()" 
                        class="bg-white text-black px-6 py-3 rounded-lg hover:bg-gray-200">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>

                    <!-- Add to Wishlist Button -->
                    <button id="wishlistBtn" onclick="toggleWishlist('<%= product._id %>')" 
                        class="border-2 <%= isInWishlist ? 'bg-red-500 border-red-500 text-white' : 'border-white text-white' %> px-6 py-3 rounded-lg hover:bg-red-500 hover:border-red-500 hover:text-white transition">
                        <i class="<%= isInWishlist ? 'fas' : 'far' %> fa-heart"></i> 
                        <%= isInWishlist ? 'In Wishlist' : 'Add to Wishlist' %>
                    </button>
                    </div>
                    <button onclick="buyNow()" 
                        class="w-full bg-cyan-400 text-black py-4 rounded-lg font-semibold hover:bg-cyan-500 transition flex items-center justify-center gap-2">
                        <i class="fas fa-bolt"></i>
                        BUY IT NOW
                    </button>
                </div>

                <!-- Description -->
                <div class="border-t border-gray-800 pt-6">
                    <h3 class="text-lg font-semibold mb-3">Description</h3>
                    <p class="text-gray-400 leading-relaxed"><%= product.description %></p>
                </div>

                <!-- Product Details -->
                <div class="border-t border-gray-800 pt-6 mt-6">
                    <h3 class="text-lg font-semibold mb-3">Product Details</h3>
                    <ul class="space-y-2 text-gray-400">
                        <li><span class="text-white">Category:</span> <%= product.category ? product.category.name : 'N/A' %></li>
                        <li><span class="text-white">Available Colors:</span> <%= product.variants ? product.variants.length : 0 %></li>
                        <li><span class="text-white">Status:</span> <%= product.status %></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Related Products -->
        <% if (relatedProducts && relatedProducts.length > 0) { %>
            <div class="mt-16">
                <h2 class="text-2xl font-bold mb-6">You May Also Like</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    <% relatedProducts.forEach(relatedProduct => { 
                        let minPrice = Infinity;
                        let maxPrice = -Infinity;
                        let firstVariant = null;
                        
                        if (relatedProduct.variants && relatedProduct.variants.length > 0) {
                            relatedProduct.variants.forEach(variant => {
                                if (variant.salePrice < minPrice) minPrice = variant.salePrice;
                                if (variant.salePrice > maxPrice) maxPrice = variant.salePrice;
                            });
                            firstVariant = relatedProduct.variants[0];
                        }
                        
                        let imageUrl = null;
                        if (firstVariant && firstVariant.images && firstVariant.images.length > 0) {
                            imageUrl = firstVariant.images[0];
                        }
                    %>
                        <a href="/product/<%= relatedProduct._id %>" class="bg-gray-900 rounded-lg overflow-hidden group hover:shadow-xl transition-all duration-300 hover:scale-105">
                            <div class="relative bg-white p-4 aspect-square flex items-center justify-center">
                                <% if (imageUrl) { %>
                                    <img src="<%= imageUrl %>" alt="<%= relatedProduct.productName %>" 
                                        class="max-w-full max-h-full object-contain">
                                <% } %>
                            </div>
                            <div class="p-3">
                                <h3 class="text-sm font-medium mb-1 line-clamp-2"><%= relatedProduct.productName %></h3>
                                <% if (relatedProduct.variants && relatedProduct.variants.length > 0) { %>
                                    <p class="text-base font-bold">₹<%= minPrice.toLocaleString() %></p>
                                <% } %>
                            </div>
                        </a>
                    <% }); %>
                </div>
            </div>
        <% } %>
    </div>

    <!-- Footer -->
    <%- include('../partials/footer') %>

    <script>
        let selectedVariantId = '<%= product.variants && product.variants.length > 0 ? product.variants[0]._id : "" %>';
        let maxQuantity = <%= product.variants && product.variants.length > 0 ? product.variants[0].quantity : 0 %>;

        function changeMainImage(imageUrl, thumbnail) {
            document.getElementById('mainImage').src = imageUrl;
            
            // Update thumbnail borders
            document.querySelectorAll('.thumbnail-item').forEach(item => {
                item.classList.remove('border-white');
                item.classList.add('border-gray-700');
            });
            thumbnail.classList.remove('border-gray-700');
            thumbnail.classList.add('border-white');
        }

        function selectVariant(button) {
            // Update selected variant
            selectedVariantId = button.dataset.variantId;
            maxQuantity = parseInt(button.dataset.quantity);
            
            // Update color name
            document.getElementById('selectedColorName').textContent = button.dataset.color;
            
            // Update price
            const price = parseFloat(button.dataset.price);
            const originalPrice = parseFloat(button.dataset.originalPrice);
            const hasDiscount = button.dataset.hasDiscount === 'true';
            const offerInfo = JSON.parse(button.dataset.offerInfo);

            const priceElement = document.getElementById('productPrice');
            const regularPriceElement = document.getElementById('productRegularPrice');
            
            priceElement.textContent = '₹' + price.toLocaleString();
            
            // Handle Price Styling and Regular Price Display
            if (hasDiscount) {
                priceElement.classList.add('text-red-400');
                regularPriceElement.style.display = 'block';
                regularPriceElement.textContent = '₹' + originalPrice.toLocaleString();
                
                // Update Offer Badge
                let badge = document.querySelector('.bg-green-100'); // Check if badge exists
                if (!badge && offerInfo) {
                    // Create badge if not exists
                    badge = document.createElement('span');
                    badge.className = 'bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300 ml-2';
                    priceElement.parentNode.appendChild(badge); // Append to the flex container
                }
                
                if (badge && offerInfo) {
                    badge.textContent = (offerInfo.type === 'percentage' ? Math.round(offerInfo.value) + '% OFF' : '₹' + offerInfo.value + ' OFF') + ` (${offerInfo.name})`;
                    badge.style.display = 'inline-block';
                }
            } else {
                priceElement.classList.remove('text-red-400');
                regularPriceElement.style.display = 'none';
                
                // Hide badge
                const badge = document.querySelector('.bg-green-100');
                if (badge) badge.style.display = 'none';
            }
            
            // Update stock status
            const stockDiv = document.getElementById('stockStatus');
            if (maxQuantity > 0) {
                stockDiv.innerHTML = `<p class="text-green-500 text-sm"><i class="fas fa-check-circle"></i> In Stock (<span id="stockQuantity">${maxQuantity}</span> available)</p>`;
            } else {
                stockDiv.innerHTML = '<p class="text-red-500 text-sm"><i class="fas fa-times-circle"></i> Out of Stock</p>';
            }
            
            // Update images
            const images = JSON.parse(button.dataset.images);
            if (images && images.length > 0) {
                document.getElementById('mainImage').src = images[0];
                
                // Update thumbnails
                const thumbnailContainer = document.getElementById('thumbnailContainer');
                thumbnailContainer.innerHTML = '';
                images.forEach((image, index) => {
                    const div = document.createElement('div');
                    div.className = `thumbnail-item bg-white rounded-lg p-2 cursor-pointer border-2 ${index === 0 ? 'border-white' : 'border-gray-700'} hover:border-gray-400 transition`;
                    div.onclick = function() { changeMainImage(image, this); };
                    div.innerHTML = `<img src="${image}" alt="Thumbnail ${index + 1}" class="w-full h-full object-contain">`;
                    thumbnailContainer.appendChild(div);
                });
            }
            
            // Update button styles
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.classList.remove('border-white', 'bg-gray-900');
                btn.classList.add('border-gray-700');
            });
            button.classList.remove('border-gray-700');
            button.classList.add('border-white', 'bg-gray-900');
            
            // Reset quantity and update max attribute
            const quantityInput = document.getElementById('quantity');
            quantityInput.value = 1;
            quantityInput.max = maxQuantity;
        }

        function increaseQuantity() {
            const input = document.getElementById('quantity');
            const currentValue = parseInt(input.value);
            const maxAllowed = maxQuantity; // Enforce 3-unit limit
            if (currentValue < maxAllowed) {
                input.value = currentValue + 1;
            }
            if(currentValue >= 3){
                input.value = 3;
               
                Swal.fire({
                    title: 'Limit Exceeded',
                    text: 'Maximum 3 units allowed per product',
                    icon: 'warning',
                    confirmButtonColor: '#1f2937'
                });
                return;
            
            }
        }

        function decreaseQuantity() {
            const input = document.getElementById('quantity');
            const currentValue = parseInt(input.value);
            if (currentValue > 1) {
                input.value = currentValue - 1;
            }
        }

        async function addToCart() {
            const quantity = parseInt(document.getElementById('quantity').value);
            
            if (maxQuantity === 0) {
                Swal.fire({
                    title: 'Out of Stock',
                    text: 'This product is out of stock!',
                    icon: 'error',
                    confirmButtonColor: '#1f2937'
                });
                return;
            }
            
               if (isNaN(quantity) || quantity < 1) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please enter a valid quantity (minimum 1)',
                    icon: 'error',
                    confirmButtonColor: '#1f2937'
                });
                return;
            }
            
            if (quantity > maxQuantity) {
                Swal.fire({
                    title: 'Insufficient Stock',
                    text: `Only ${maxQuantity} items available!`,
                    icon: 'warning',
                    confirmButtonColor: '#1f2937'
                });
                return;
            }

            if (quantity > 3) {
                Swal.fire({
                    title: 'Limit Exceeded',
                    text: 'Maximum 3 units allowed per product',
                    icon: 'warning',
                    confirmButtonColor: '#1f2937'
                });
                return;
            }

            try {
                const response = await fetch('/cart/add', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: '<%= product._id %>',
                        variantId: selectedVariantId,
                        quantity: quantity
                    })
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        title: 'Added to Cart!',
                        text: 'Product added to your cart',
                        icon: 'success',
                        confirmButtonColor: '#1f2937',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: result.message,
                        icon: 'error',
                        confirmButtonColor: '#1f2937'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to add to cart',
                    icon: 'error',
                    confirmButtonColor: '#1f2937'
                });
            }
        }

        let isInWishlist = <%= isInWishlist ? 'true' : 'false' %>;

        async function toggleWishlist(productId) {
            try {
                const endpoint = isInWishlist ? '/wishlist/remove' : '/wishlist/add';
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId })
                });

                const result = await response.json();

                if (result.success) {
                    isInWishlist = !isInWishlist;
                    updateWishlistButton();
                    
                    Swal.fire({
                        icon: 'success',
                        title: isInWishlist ? 'Added to Wishlist!' : 'Removed from Wishlist',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                } else {
                    Swal.fire({
                        title: 'Info',
                        text: result.message,
                        icon: 'info',
                        confirmButtonColor: '#1f2937'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to update wishlist',
                    icon: 'error',
                    confirmButtonColor: '#1f2937'
                });
            }
        }

        function updateWishlistButton() {
            const btn = document.getElementById('wishlistBtn');
            const icon = btn.querySelector('i');
            
            if (isInWishlist) {
                btn.className = 'border-2 bg-red-500 border-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 hover:border-red-600 transition';
                icon.className = 'fas fa-heart';
                btn.innerHTML = '<i class="fas fa-heart"></i> In Wishlist';
            } else {
                btn.className = 'border-2 border-white text-white px-6 py-3 rounded-lg hover:bg-red-500 hover:border-red-500 hover:text-white transition';
                icon.className = 'far fa-heart';
                btn.innerHTML = '<i class="far fa-heart"></i> Add to Wishlist';
            }
        }

        async function addToWishlist() {
            // TODO: Implement wishlist functionality
            console.log('Add to wishlist:', {
                productId: '<%= product._id %>',
                variantId: selectedVariantId
            });
            
            Swal.fire({
                title: 'Added to Wishlist!',
                text: 'Added to wishlist! (Wishlist functionality coming soon)',
                icon: 'success',
                confirmButtonColor: '#1f2937',
                timer: 2000
            });
        }

       async function buyNow() {
    const quantity = parseInt(document.getElementById('quantity').value);
    
    if (maxQuantity === 0) {
        Swal.fire({
            title: 'Out of Stock',
            text: 'This product is out of stock!',
            icon: 'error',
            confirmButtonColor: '#1f2937'
        });
        return;
    }
    
    if (isNaN(quantity) || quantity < 1) {
        Swal.fire({
            title: 'Error',
            text: 'Please enter a valid quantity (minimum 1)',
            icon: 'error',
            confirmButtonColor: '#1f2937'
        });
        return;
    }

    if (quantity > maxQuantity) {
        Swal.fire({
            title: 'Insufficient Stock',
            text: `Only ${maxQuantity} items available!`,
            icon: 'warning',
            confirmButtonColor: '#1f2937'
        });
        return;
    }

    if (quantity > 3) {
        Swal.fire({
            title: 'Limit Exceeded',
            text: 'Maximum 3 units allowed per product',
            icon: 'warning',
            confirmButtonColor: '#1f2937'
        });
        return;
    }

    // Get selected variant details for the modal
    const selectedColorElement = document.getElementById('selectedColorName');
    const selectedColor = selectedColorElement ? selectedColorElement.textContent : 'Default';
    const priceElement = document.getElementById('productPrice');
    const price = priceElement ? priceElement.textContent : '₹0';
    
    // Calculate total price
    const unitPrice = parseFloat(price.replace('₹', '').replace(',', ''));
    const totalPrice = unitPrice * quantity;

    // Show confirmation modal with product details
    const result = await Swal.fire({
        title: 'Confirm Purchase',
        html: `
            <div class="text-left bg-gray-100 p-4 rounded-lg mb-4">
                <h3 class="font-semibold text-gray-800 mb-2">Product Details:</h3>
                <div class="space-y-1 text-sm text-gray-600">
                    <p><strong>Product:</strong> <%= product.productName %></p>
                    <p><strong>Color:</strong> ${selectedColor}</p>
                    <p><strong>Quantity:</strong> ${quantity}</p>
                    <p><strong>Unit Price:</strong> ${price}</p>
                    <p class="text-lg font-semibold text-gray-800 border-t pt-2 mt-2">
                        <strong>Total: ₹${totalPrice.toLocaleString()}</strong>
                    </p>
                </div>
            </div>
            <p class="text-gray-600">Do you want to proceed to checkout with this item?</p>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#06b6d4',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '<i class="fas fa-shopping-cart mr-2"></i>Yes, Buy Now',
        cancelButtonText: '<i class="fas fa-times mr-2"></i>Cancel',
        customClass: {
            popup: 'swal-wide',
            confirmButton: 'swal-confirm-btn',
            cancelButton: 'swal-cancel-btn'
        },
        buttonsStyling: false
    });

    // If user confirms, proceed with buy now
    if (result.isConfirmed) {
        try {
            // Show processing modal
            Swal.fire({
                title: 'Processing...',
                text: 'Preparing your order',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch('/buy-now', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    productId: '<%= product._id %>',
                    variantId: selectedVariantId,
                    quantity: quantity
                })
            });

            const result = await response.json();

            if (result.success) {
                // Show success message briefly before redirect
                await Swal.fire({
                    icon: 'success',
                    title: 'Order Prepared!',
                    text: 'Redirecting to checkout...',
                    timer: 1500,
                    showConfirmButton: false
                });
                
                // Redirect to buy now checkout
                window.location.href = result.redirectUrl;
            } else {
                Swal.fire({
                    title: 'Error',
                    text: result.message,
                    icon: 'error',
                    confirmButtonColor: '#1f2937'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Failed to process buy now',
                icon: 'error',
                confirmButtonColor: '#1f2937'
            });
        }
    }
}


        // Update quantity input max attribute (enforce 3-unit limit)
        document.getElementById('quantity').max = Math.min(maxQuantity, 3);

        // ===== IMAGE MAGNIFIER (Lens with Zoom Inside) =====
        const imageContainer = document.getElementById('imageContainer');
        const mainImage = document.getElementById('mainImage');
        const magnifierLens = document.getElementById('magnifierLens');
        
        let isZooming = false;
        let magnifierInitialized = false;

        // Initialize magnifier on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing magnifier...');
            
            // Check if all required elements exist
            if (!imageContainer) {
                console.error('Image container not found!');
                return;
            }
            if (!mainImage) {
                console.error('Main image not found!');
                return;
            }
            if (!magnifierLens) {
                console.error('Magnifier lens not found!');
                return;
            }
            
            console.log('All magnifier elements found, proceeding with initialization');
            initMagnifier();
        });

        function initMagnifier() {
            if (magnifierInitialized) return; // Prevent duplicate initialization
            
            console.log('Initializing image magnifier...');
            
            // Mouse enter - show lens
            imageContainer.addEventListener('mouseenter', function() {
                console.log('Mouse entered image container');
                console.log('Image complete:', mainImage.complete);
                console.log('Image natural width:', mainImage.naturalWidth);
                
                if (mainImage.complete && mainImage.naturalWidth > 0) {
                    magnifierLens.classList.remove('hidden');
                    isZooming = true;
                    console.log('Magnifier lens activated');
                } else {
                    console.log('Image not ready for magnification');
                }
            });

            // Mouse leave - hide lens
            imageContainer.addEventListener('mouseleave', function() {
                magnifierLens.classList.add('hidden');
                isZooming = false;
            });

            // Mouse move - update lens position and show zoom inside lens
            imageContainer.addEventListener('mousemove', function(e) {
                if (!isZooming || !mainImage.complete) return;
                
                try {
                    const rect = imageContainer.getBoundingClientRect();
                    const imgRect = mainImage.getBoundingClientRect();
                    
                    // Calculate cursor position relative to image
                    let x = e.clientX - imgRect.left;
                    let y = e.clientY - imgRect.top;
                    
                    // Lens size (w-40 = 160px)
                    const lensSize = 160;
                    
                    // Prevent lens from going outside image bounds
                    x = Math.max(lensSize / 2, Math.min(x, imgRect.width - lensSize / 2));
                    y = Math.max(lensSize / 2, Math.min(y, imgRect.height - lensSize / 2));
                    
                    // Position the lens centered on cursor
                    const lensLeft = (x - lensSize / 2 + (imgRect.left - rect.left));
                    const lensTop = (y - lensSize / 2 + (imgRect.top - rect.top));
                    
                    magnifierLens.style.left = lensLeft + 'px';
                    magnifierLens.style.top = lensTop + 'px';
                    
                    // Calculate zoom inside the lens
                    const zoomLevel = 2.5;
                    const bgPosX = -(x * zoomLevel - lensSize / 2);
                    const bgPosY = -(y * zoomLevel - lensSize / 2);
                    
                    // Set background image and position inside the lens
                    magnifierLens.style.backgroundImage = `url('${mainImage.src}')`;
                    magnifierLens.style.backgroundSize = `${imgRect.width * zoomLevel}px ${imgRect.height * zoomLevel}px`;
                    magnifierLens.style.backgroundPosition = `${bgPosX}px ${bgPosY}px`;
                    magnifierLens.style.backgroundRepeat = 'no-repeat';
                    
                    // Debug log (remove in production)
                    if (Math.random() < 0.01) { // Log occasionally to avoid spam
                        console.log('Magnifier active:', { x, y, lensLeft, lensTop, zoomLevel });
                    }
                } catch (error) {
                    console.error('Error in magnifier mousemove:', error);
                }
            });
            
            magnifierInitialized = true;
            console.log('Image magnifier initialized successfully');
        }

        // Enhanced changeMainImage function with magnifier support
        const originalChangeMainImage = window.changeMainImage;
        window.changeMainImage = function(imageUrl, thumbnail) {
            // Hide lens during image change
            magnifierLens.classList.add('hidden');
            isZooming = false;
            
            // Call original function logic
            document.getElementById('mainImage').src = imageUrl;
            
            // Update thumbnail borders
            document.querySelectorAll('.thumbnail-item').forEach(item => {
                item.classList.remove('border-white');
                item.classList.add('border-gray-700');
            });
            thumbnail.classList.remove('border-gray-700');
            thumbnail.classList.add('border-white');
            
            // Wait for new image to load before re-enabling magnifier
            const newImage = document.getElementById('mainImage');
            newImage.onload = function() {
                console.log('New image loaded, magnifier ready');
            };
            newImage.onerror = function() {
                console.error('Failed to load image:', imageUrl);
            };
        };

        // Handle image load errors
        mainImage.addEventListener('error', function() {
            console.error('Main image failed to load');
            magnifierLens.classList.add('hidden');
            isZooming = false;
        });

        // Ensure magnifier works when image is already loaded
        if (mainImage.complete && mainImage.naturalWidth > 0) {
            console.log('Main image already loaded');
        }

        

async function addToWishlist(productId) {
    try {
        const response = await fetch('/wishlist/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Added to Wishlist!',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            Swal.fire('Error', result.message, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
    </script>
</body>
</html>
