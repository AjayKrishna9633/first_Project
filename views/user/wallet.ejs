<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wallet - GEARGRID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/public/css/text-wrap.css">
    <link rel="stylesheet" href="/public/css/responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #000;
        }
        .wallet-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: transform 0.3s ease;
        }
        .wallet-card:hover {
            transform: translateY(-5px);
        }
        .transaction-item {
            transition: all 0.3s ease;
        }
        .transaction-item:hover {
            background-color: #1f2937;
        }
        .referral-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .copy-btn {
            transition: all 0.3s ease;
        }
        .copy-btn:hover {
            transform: scale(1.05);
        }

        /* Mobile responsive fixes for wallet page */
        @media (max-width: 768px) {
            .wallet-container {
                flex-direction: column !important;
                gap: 0 !important;
            }
            .wallet-sidebar {
                width: 100% !important;
                margin-bottom: 1.5rem;
            }
            .wallet-content {
                width: 100%;
            }
            
            /* Transaction card mobile layout */
            .transaction-card-layout {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 1rem !important;
            }
            
            .transaction-info {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .transaction-amount-section {
                width: 100%;
                text-align: left !important;
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding-top: 0.75rem;
                border-top: 1px solid rgba(75, 85, 99, 0.5);
            }
            
            .transaction-amount-section > p:first-child {
                order: 1;
            }
            
            .transaction-amount-section > p:nth-child(2) {
                order: 3;
                font-size: 0.75rem !important;
            }
            
            .transaction-amount-section > span {
                order: 2;
            }
            
            /* Better spacing for transaction description */
            .transaction-item p.font-semibold {
                font-size: 0.9rem;
                line-height: 1.3rem;
            }
            
            .transaction-item p.text-sm {
                font-size: 0.75rem;
            }
            
            .transaction-item p.text-xs {
                font-size: 0.7rem;
            }
            
            /* Amount on mobile */
            .transaction-amount-section .text-xl {
                font-size: 1.125rem !important;
            }
            
            /* Icon size on mobile */
            .transaction-item .w-12.h-12 {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }
            
            .transaction-item .w-12.h-12 i {
                font-size: 1rem !important;
            }
            
            /* Statistics cards stack on mobile */
            .wallet-content .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
            
            /* Filter inputs stack on mobile */
            .wallet-content .md\\:col-span-1 {
                grid-column: span 1 !important;
            }
            
            /* Wallet balance card text size */
            .wallet-card .text-5xl {
                font-size: 2.5rem !important;
            }
            
            /* Referral card adjustments */
            .referral-card .text-2xl {
                font-size: 1.5rem !important;
            }
        }
    </style>
</head>
<body class="bg-black text-white">
    <!-- Header -->
    <%- include('../partials/header') %>

    <!-- Breadcrumb -->
    <div class="bg-gray-900 border-b border-gray-800 mt-20">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center text-sm">
                <a href="/" class="text-gray-300 hover:text-white transition">Home</a>
                <i class="fas fa-chevron-right mx-2 text-xs text-gray-500"></i>
                <span class="text-white font-medium">My Wallet</span>
            </div>
        </div>
    </div>

    <!-- Page Title -->
    <div class="bg-gray-900 py-8 px-6 border-b border-gray-800">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-4xl font-bold text-white mb-2">My Wallet</h1>
            <p class="text-gray-400">
                <i class="fas fa-wallet text-cyan-400"></i> Manage your wallet balance and transactions
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-12 px-6 pb-24">
        <div class="flex gap-8 wallet-container">
            <!-- Sidebar -->
            <div class="wallet-sidebar">
            <%- include('../partials/sideBar') %>
            </div>
            
            <!-- Main Wallet Content -->
            <div class="flex-1 wallet-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column - Wallet Balance & Actions -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Wallet Balance Card -->
                <div class="wallet-card rounded-2xl p-8 text-white shadow-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-medium opacity-90">Wallet Balance</h2>
                        <i class="fas fa-wallet text-3xl opacity-80"></i>
                    </div>
                    <div class="mb-6">
                        <p class="text-5xl font-bold">₹<%= walletBalance.toLocaleString() %></p>
                        <p class="text-sm opacity-80 mt-2">Available Balance</p>
                    </div>
                    <button onclick="showAddMoneyModal()" 
                            class="w-full bg-white text-purple-600 font-semibold py-3 rounded-lg hover:bg-gray-100 transition flex items-center justify-center gap-2">
                        <i class="fas fa-plus-circle"></i>
                        Add Money
                    </button>
                </div>

                <!-- Referral Card -->
                <div class="referral-card rounded-2xl p-6 text-white shadow-2xl">
                    <div class="flex items-center gap-3 mb-4">
                        <i class="fas fa-gift text-3xl"></i>
                        <div>
                            <h3 class="text-xl font-bold">Refer & Earn</h3>
                            <p class="text-sm opacity-90">Share your code</p>
                        </div>
                    </div>
                    
                    <div class="bg-white/20 backdrop-blur-sm rounded-lg p-4 mb-4">
                        <p class="text-xs opacity-90 mb-2">Your Referral Code</p>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-bold tracking-wider"><%= referralCode %></span>
                            <button onclick="copyReferralCode()" 
                                    class="copy-btn bg-white/30 hover:bg-white/40 px-4 py-2 rounded-lg">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-300"></i>
                            <span>You earn ₹500 per referral</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-300"></i>
                            <span>Friend gets ₹100 bonus</span>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-white/20">
                        <p class="text-xs opacity-80">Total Earnings</p>
                        <p class="text-2xl font-bold">₹<%= referralEarnings.toLocaleString() %></p>
                    </div>
                </div>

                <!-- Apply Referral Code -->
                <% if (!hasUsedReferral) { %>
                <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-ticket-alt text-cyan-400"></i>
                        Have a Referral Code?
                    </h3>
                    <p class="text-sm text-gray-400 mb-4">Enter a friend's code and get ₹100 instantly!</p>
                    <div class="space-y-3">
                        <input type="text" 
                               id="referralCodeInput" 
                               placeholder="Enter 6-digit code"
                               maxlength="6"
                               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white uppercase focus:outline-none focus:border-cyan-400">
                        <button onclick="applyReferralCode()" 
                                class="w-full bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                            Apply
                        </button>
                    </div>
                    <p class="text-xs text-yellow-400 mt-3">
                        <i class="fas fa-info-circle"></i> You can only use one referral code per account
                    </p>
                </div>
                <% } else { %>
                <div class="bg-gray-900 rounded-2xl p-6 border border-green-800">
                    <div class="flex items-center gap-3 text-green-400">
                        <i class="fas fa-check-circle text-2xl"></i>
                        <div>
                            <p class="font-semibold">Referral Code Applied</p>
                            <p class="text-sm text-gray-400">Code: <%= typeof referredBy !== 'undefined' ? referredBy : 'N/A' %></p>
                        </div>
                    </div>
                </div>
                <% } %>

            </div>

            <!-- Right Column - Transaction History -->
            <div class="lg:col-span-2">
                <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
                    <div class="p-6 border-b border-gray-800">
                        <h2 class="text-2xl font-bold flex items-center gap-3 mb-6">
                            <i class="fas fa-history text-cyan-400"></i>
                            Transaction History
                        </h2>

                        <!-- Statistics Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Money Added</p>
                                        <p class="text-xl font-bold text-green-400">₹<%= statistics.totalAdded.toLocaleString() %></p>
                                    </div>
                                    <i class="fas fa-plus-circle text-2xl text-green-400"></i>
                                </div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Referral Earned</p>
                                        <p class="text-xl font-bold text-purple-400">₹<%= statistics.totalReferral.toLocaleString() %></p>
                                    </div>
                                    <i class="fas fa-gift text-2xl text-purple-400"></i>
                                </div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Money Used</p>
                                        <p class="text-xl font-bold text-red-400">₹<%= statistics.totalUsed.toLocaleString() %></p>
                                    </div>
                                    <i class="fas fa-shopping-cart text-2xl text-red-400"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Filters and Search -->
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Search -->
                                <div class="md:col-span-1">
                                    <input type="text" 
                                           id="searchInput" 
                                           placeholder="Search transactions..."
                                           value="<%= searchQuery %>"
                                           class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-cyan-400">
                                </div>
                                
                                <!-- Type Filter -->
                                <div>
                                    <select id="typeFilter" 
                                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-cyan-400">
                                        <option value="all" <%= filterType === 'all' ? 'selected' : '' %>>All Types</option>
                                        <option value="credit" <%= filterType === 'credit' ? 'selected' : '' %>>Credit Only</option>
                                        <option value="debit" <%= filterType === 'debit' ? 'selected' : '' %>>Debit Only</option>
                                    </select>
                                </div>
                                
                                <!-- Method Filter -->
                                <div>
                                    <select id="methodFilter" 
                                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-cyan-400">
                                        <option value="all" <%= filterMethod === 'all' ? 'selected' : '' %>>All Methods</option>
                                        <option value="razorpay" <%= filterMethod === 'razorpay' ? 'selected' : '' %>>Money Added</option>
                                        <option value="referral" <%= filterMethod === 'referral' ? 'selected' : '' %>>Referral</option>
                                        <option value="wallet" <%= filterMethod === 'wallet' ? 'selected' : '' %>>Wallet Payment</option>
                                        <option value="refund" <%= filterMethod === 'refund' ? 'selected' : '' %>>Refund</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-gray-400">
                                    Showing <%= transactions.length %> of <%= totalTransactions %> transactions
                                </p>
                                <button onclick="clearFilters()" 
                                        class="text-sm text-cyan-400 hover:text-cyan-300 transition">
                                    <i class="fas fa-redo"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="p-6">
                        <% if (transactions && transactions.length > 0) { %>
                            <div class="space-y-3">
                                <% transactions.forEach(transaction => { %>
                                    <div class="transaction-item bg-gray-800 rounded-lg p-4 border border-gray-700">
                                        <div class="flex items-center justify-between transaction-card-layout">
                                            <div class="flex items-center gap-4 transaction-info">
                                                <div class="w-12 h-12 rounded-full flex items-center justify-center <%= transaction.type === 'credit' ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400' %>">
                                                    <i class="fas <%= transaction.type === 'credit' ? 'fa-arrow-down' : 'fa-arrow-up' %> text-xl"></i>
                                                </div>
                                                <div>
                                                    <p class="font-semibold text-white">
                                                        <%= transaction.description || (transaction.type === 'credit' ? 'Money Added' : 'Payment') %>
                                                    </p>
                                                    <p class="text-sm text-gray-400">
                                                        <%= new Date(transaction.createdAt).toLocaleDateString('en-IN', { 
                                                            day: 'numeric', 
                                                            month: 'short', 
                                                            year: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        }) %>
                                                    </p>
                                                    <% if (transaction.orderId) { %>
                                                        <p class="text-xs text-cyan-400 mt-1">
                                                            Order #<%= transaction.orderId.orderNumber %>
                                                        </p>
                                                    <% } %>
                                                </div>
                                            </div>
                                            <div class="text-right transaction-amount-section">
                                                <p class="text-xl font-bold <%= transaction.type === 'credit' ? 'text-green-400' : 'text-red-400' %>">
                                                    <%= transaction.type === 'credit' ? '+' : '-' %>₹<%= transaction.amount.toLocaleString() %>
                                                </p>
                                                <p class="text-sm text-gray-400">
                                                    Balance: ₹<%= transaction.balance.toLocaleString() %>
                                                </p>
                                                <span class="inline-block mt-1 px-2 py-1 text-xs rounded-full <%= transaction.status === 'success' ? 'bg-green-900/50 text-green-400' : transaction.status === 'failed' ? 'bg-red-900/50 text-red-400' : 'bg-yellow-900/50 text-yellow-400' %>">
                                                    <%= transaction.status %>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="text-center py-16">
                                <i class="fas fa-receipt text-6xl text-gray-700 mb-4"></i>
                                <p class="text-gray-400 text-lg">No transactions yet</p>
                                <p class="text-gray-500 text-sm mt-2">Your transaction history will appear here</p>
                            </div>
                        <% } %>

                        <!-- Pagination -->
                        <% if (totalPages > 1) { %>
                        <div class="mt-8 mb-4 flex items-center justify-center gap-2">
                            <!-- Previous Button -->
                            <% if (currentPageNumber > 1) { %>
                                <a href="?page=<%= currentPageNumber - 1 %>&filter=<%= filterType %>&method=<%= filterMethod %>&search=<%= searchQuery %>" 
                                   class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            <% } else { %>
                                <button disabled class="px-4 py-2 bg-gray-800 text-gray-600 rounded-lg cursor-not-allowed">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                            <% } %>

                            <!-- Page Numbers -->
                            <% 
                                let startPage = Math.max(1, currentPageNumber - 2);
                                let endPage = Math.min(totalPages, currentPageNumber + 2);
                                
                                if (currentPageNumber <= 3) {
                                    endPage = Math.min(5, totalPages);
                                }
                                if (currentPageNumber > totalPages - 3) {
                                    startPage = Math.max(1, totalPages - 4);
                                }
                            %>

                            <% if (startPage > 1) { %>
                                <a href="?page=1&filter=<%= filterType %>&method=<%= filterMethod %>&search=<%= searchQuery %>" 
                                   class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition">1</a>
                                <% if (startPage > 2) { %>
                                    <span class="px-2 text-gray-500">...</span>
                                <% } %>
                            <% } %>

                            <% for (let i = startPage; i <= endPage; i++) { %>
                                <a href="?page=<%= i %>&filter=<%= filterType %>&method=<%= filterMethod %>&search=<%= searchQuery %>" 
                                   class="px-4 py-2 <%= i === currentPageNumber ? 'bg-cyan-500 text-white' : 'bg-gray-800 text-white hover:bg-gray-700' %> rounded-lg transition">
                                    <%= i %>
                                </a>
                            <% } %>

                            <% if (endPage < totalPages) { %>
                                <% if (endPage < totalPages - 1) { %>
                                    <span class="px-2 text-gray-500">...</span>
                                <% } %>
                                <a href="?page=<%= totalPages %>&filter=<%= filterType %>&method=<%= filterMethod %>&search=<%= searchQuery %>" 
                                   class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition"><%= totalPages %></a>
                            <% } %>

                            <!-- Next Button -->
                            <% if (currentPageNumber < totalPages) { %>
                                <a href="?page=<%= currentPageNumber + 1 %>&filter=<%= filterType %>&method=<%= filterMethod %>&search=<%= searchQuery %>" 
                                   class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            <% } else { %>
                                <button disabled class="px-4 py-2 bg-gray-800 text-gray-600 rounded-lg cursor-not-allowed">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            <% } %>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <%- include('../partials/footer') %>

    <script>
        // Copy Referral Code
        function copyReferralCode() {
            const code = '<%= referralCode %>';
            navigator.clipboard.writeText(code).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Copied!',
                    text: 'Referral code copied to clipboard',
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        }

        // Filter and Search functionality
        let searchTimeout;
        
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 500);
        });

        document.getElementById('typeFilter').addEventListener('change', applyFilters);
        document.getElementById('methodFilter').addEventListener('change', applyFilters);

        function applyFilters() {
            const search = document.getElementById('searchInput').value;
            const type = document.getElementById('typeFilter').value;
            const method = document.getElementById('methodFilter').value;
            
            window.location.href = `/wallet?page=1&filter=${type}&method=${method}&search=${encodeURIComponent(search)}`;
        }

        function clearFilters() {
            window.location.href = '/wallet';
        }

        // Show Add Money Modal
        function showAddMoneyModal() {
            Swal.fire({
                title: '<i class="fas fa-plus-circle text-cyan-400"></i> Add Money to Wallet',
                html: `
                    <div class="text-left mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enter Amount</label>
                        <input type="number" 
                               id="addMoneyAmount" 
                               placeholder="Enter amount (₹100 - ₹50,000)"
                               min="100"
                               max="50000"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle"></i> Minimum: ₹100 | Maximum: ₹50,000
                        </p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Proceed to Pay',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#06b6d4',
                cancelButtonColor: '#6b7280',
                preConfirm: () => {
                    const amount = document.getElementById('addMoneyAmount').value;
                    if (!amount || amount < 100) {
                        Swal.showValidationMessage('Minimum amount is ₹100');
                        return false;
                    }
                    if (amount > 50000) {
                        Swal.showValidationMessage('Maximum amount is ₹50,000');
                        return false;
                    }
                    return amount;
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await initiatePayment(result.value);
                }
            });
        }

        // Initiate Payment
        async function initiatePayment(amount) {
            try {
                Swal.fire({
                    title: 'Processing...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch('/wallet/add-money', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseInt(amount) })
                });

                const result = await response.json();

                if (result.success) {
                    Swal.close();
                    
                    // Open Razorpay
                    const options = {
                        "key": result.razorpayOrder.key_id,
                        "amount": result.razorpayOrder.amount,
                        "currency": result.razorpayOrder.currency,
                        "name": result.razorpayOrder.name,
                        "description": result.razorpayOrder.description,
                        "order_id": result.razorpayOrder.id,
                        "handler": async function (response) {
                            await verifyPayment(response, result.razorpayOrder.amount);
                        },
                        "prefill": {
                            "contact": result.razorpayOrder.contact,
                            "email": result.razorpayOrder.email
                        },
                        "theme": {
                            "color": "#06b6d4"
                        },
                        "modal": {
                            "ondismiss": function() {
                                Swal.fire('Cancelled', 'Payment was cancelled', 'info');
                            }
                        }
                    };
                    
                    const rzp = new Razorpay(options);
                    rzp.open();
                } else {
                    Swal.fire('Error', result.message, 'error');
                }
            } catch (error) {
                console.error('Payment error:', error);
                Swal.fire('Error', 'Failed to initiate payment', 'error');
            }
        }

        // Verify Payment
        async function verifyPayment(response, amount) {
            try {
                Swal.fire({
                    title: 'Verifying Payment...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const verifyResponse = await fetch('/wallet/verify-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature,
                        amount: amount
                    })
                });

                const result = await verifyResponse.json();

                if (result.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: result.message,
                        confirmButtonColor: '#10b981'
                    });
                    location.reload();
                } else {
                    Swal.fire('Failed', result.message, 'error');
                }
            } catch (error) {
                console.error('Verification error:', error);
                Swal.fire('Error', 'Payment verification failed', 'error');
            }
        }

        // Apply Referral Code
        async function applyReferralCode() {
            const code = document.getElementById('referralCodeInput').value.trim().toUpperCase();
            
            if (!code || code.length !== 6) {
                Swal.fire('Invalid Code', 'Please enter a valid 6-character referral code', 'error');
                return;
            }

            try {
                Swal.fire({
                    title: 'Applying Code...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch('/wallet/apply-referral', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ referralCode: code })
                });

                const result = await response.json();

                if (result.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: result.message,
                        confirmButtonColor: '#10b981'
                    });
                    location.reload();
                } else {
                    Swal.fire('Failed', result.message, 'error');
                }
            } catch (error) {
                console.error('Apply referral error:', error);
                Swal.fire('Error', 'Failed to apply referral code', 'error');
            }
        }
    </script>
</body>
</html>
